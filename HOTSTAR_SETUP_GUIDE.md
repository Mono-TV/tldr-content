# Hotstar Integration - Quick Setup Guide

**Date:** January 10, 2026
**Status:** âœ… Ready to Deploy

---

## ðŸ“‹ Prerequisites

1. **PostgreSQL** installed and running
2. **Python 3** with required packages
3. **Hotstar API credentials** (already configured in `web/.env.local`)

---

## ðŸš€ Quick Start (5 Steps)

### Step 1: Install Python Dependencies

```bash
pip3 install psycopg2-binary requests
```

### Step 2: Create Database

```bash
# Create separate database for Hotstar source data
createdb hotstar_source
```

### Step 3: Run Migrations

```bash
# Run all three migrations in order
psql hotstar_source < migrations/001_create_hotstar_movies.sql
psql hotstar_source < migrations/002_create_sync_log.sql
psql hotstar_source < migrations/003_create_api_tokens.sql
```

Verify tables were created:
```bash
psql hotstar_source -c "\dt"
```

Expected output:
```
                  List of relations
 Schema |         Name          | Type  |  Owner
--------+-----------------------+-------+----------
 public | hotstar_api_tokens    | table | postgres
 public | hotstar_movies        | table | postgres
 public | hotstar_sync_log      | table | postgres
```

### Step 4: Run Initial Ingestion

```bash
# This will ingest all 51,495 movies in ~1-2 minutes
python3 scripts/ingest-hotstar-movies.py
```

Expected output:
```
============================================================
HOTSTAR MOVIE INGESTION - INITIAL FULL SYNC
============================================================

ðŸ“¥ Phase 1: Fetching first 10,000 movies...
------------------------------------------------------------
  Batch 1/10: Movies 0 to 1,000
  âœ“ Saved 1000 movies (Total: 1,000)
  ...

ðŸ“¥ Phase 2: Fetching remaining movies (date-based)...
------------------------------------------------------------
  ðŸ“… Fetching 2024-2025 movies...
    Batch 1: +1000 movies (Total: 11,000)
  ...

============================================================
âœ… INGESTION COMPLETE!
============================================================
  Total Movies:     51,495
  Items Added:      51,495
  Items Updated:    0
  API Requests:     52
  Errors:           0
  Time Taken:       67.3s (1.1 min)
============================================================
```

### Step 5: Set Up Daily Sync (Cron Job)

```bash
# Edit crontab
crontab -e

# Add this line to run daily at 2 AM
0 2 * * * cd /Users/mono/Documents/Programs/Lumio/tldrcontent && python3 scripts/sync-hotstar-daily.py >> logs/hotstar-sync.log 2>&1
```

Create logs directory:
```bash
mkdir -p logs
```

---

## ðŸ” Verify Installation

### Check Movie Count

```bash
psql hotstar_source -c "SELECT COUNT(*) FROM hotstar_movies;"
```

Expected: `51495` (or more if new movies added)

### Check Recent Movies

```bash
psql hotstar_source -c "
  SELECT title, year, lang, premium
  FROM hotstar_movies
  ORDER BY api_update_date DESC
  LIMIT 10;
"
```

### Check Sync Logs

```bash
psql hotstar_source -c "
  SELECT
    sync_type,
    started_at,
    status,
    items_added,
    items_updated,
    duration_seconds
  FROM hotstar_sync_log
  ORDER BY started_at DESC;
"
```

---

## ðŸ“Š Database Schema Summary

### Tables Created

1. **`hotstar_movies`** (51,495+ rows)
   - Complete movie metadata
   - JSONB fields for complex data (genres, actors, images)
   - Soft deletion tracking
   - Raw API response storage

2. **`hotstar_sync_log`** (1 row per sync)
   - Tracks all sync operations
   - Statistics (added, updated, deleted)
   - Error tracking
   - Performance metrics

3. **`hotstar_api_tokens`** (1 row per token)
   - Stores generated Akamai tokens
   - Expiration tracking
   - Auto-generated by scripts

---

## ðŸ”„ Daily Operations

### Manual Daily Sync

```bash
# Run manually anytime
python3 scripts/sync-hotstar-daily.py
```

Expected output (typical day):
```
============================================================
HOTSTAR DAILY SYNC
============================================================

ðŸ“… Time Window:
  From: 2026-01-09 02:00:00
  To:   2026-01-10 02:00:00

ðŸ“¥ Fetching updated movies...
  Found 15 updated movies
  âœ“ Added: 5
  âœ“ Updated: 10

============================================================
âœ… DAILY SYNC COMPLETE!
============================================================
  Fetched:          15
  Added:            5
  Updated:          10
  Deleted:          0
  API Requests:     1
  Time Taken:       2.3s
============================================================
```

### Weekly Deletion Check

Every Monday, the daily sync also checks for deleted movies:
```
ðŸ—‘ï¸  Checking for deletions (weekly check)...
  Fetching all active content IDs...
  Found 51,500 active movies
  Found 3 deleted movies
  âœ“ Marked 3 as deleted
```

---

## ðŸ› ï¸ Troubleshooting

### Issue: Database Connection Failed

**Error:** `Database connection failed: could not connect to server`

**Solution:**
```bash
# Check PostgreSQL is running
pg_isready

# Check database exists
psql -l | grep hotstar_source

# If not, create it
createdb hotstar_source
```

### Issue: Token Generation Failed

**Error:** `Token generation failed`

**Solution:**
```bash
# Test token generation manually
python3 scripts/generate-token.py

# Should output a token like:
# st=1768057103~exp=1768059103~acl=/*~hmac=408a16...
```

### Issue: 403 Forbidden from API

**Error:** `403 Client Error: Forbidden`

**Solution:**
- Token expired (regenerate automatically on next run)
- Check `.env.local` has correct `HOTSTAR_AKAMAI_SECRET`
- Verify API credentials are valid

### Issue: Missing Python Packages

**Error:** `ModuleNotFoundError: No module named 'psycopg2'`

**Solution:**
```bash
pip3 install psycopg2-binary requests
```

---

## ðŸ“ˆ Monitoring

### Check Sync Health

```sql
-- Last 10 syncs
SELECT
  sync_type,
  started_at,
  completed_at,
  status,
  items_added,
  items_updated,
  items_deleted,
  duration_seconds
FROM hotstar_sync_log
ORDER BY started_at DESC
LIMIT 10;
```

### Get Statistics

```sql
-- Total movies by language
SELECT
  lang->0 as language,
  COUNT(*) as count
FROM hotstar_movies
WHERE is_deleted = false
GROUP BY lang->0
ORDER BY count DESC
LIMIT 10;

-- Premium vs Free
SELECT
  premium,
  COUNT(*) as count
FROM hotstar_movies
WHERE is_deleted = false
GROUP BY premium;

-- Movies added in last 7 days
SELECT COUNT(*)
FROM hotstar_movies
WHERE created_at > NOW() - INTERVAL '7 days';
```

---

## ðŸŽ¯ Next Steps

After setup is complete:

1. **Verify Data Quality**
   ```bash
   psql hotstar_source -c "SELECT COUNT(*) FROM hotstar_movies WHERE title IS NULL;"
   # Should be 0
   ```

2. **Test Daily Sync**
   ```bash
   python3 scripts/sync-hotstar-daily.py
   # Should complete in <10 seconds
   ```

3. **Set Up Monitoring**
   - Add alerting for failed syncs
   - Create dashboard for sync statistics
   - Monitor database size growth

4. **Integration with TLDR Content**
   - Map Hotstar data to TLDR content model
   - Create API endpoints to serve Hotstar content
   - Build UI components for Hotstar movies

---

## ðŸ“ File Structure

```
tldrcontent/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 001_create_hotstar_movies.sql   âœ… Movie metadata table
â”‚   â”œâ”€â”€ 002_create_sync_log.sql         âœ… Sync tracking table
â”‚   â””â”€â”€ 003_create_api_tokens.sql       âœ… Token storage table
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate-token.py               âœ… Akamai token generator
â”‚   â”œâ”€â”€ ingest-hotstar-movies.py        âœ… Initial full ingestion
â”‚   â””â”€â”€ sync-hotstar-daily.py           âœ… Daily incremental sync
â”œâ”€â”€ web/.env.local                      âœ… API credentials
â””â”€â”€ logs/
    â””â”€â”€ hotstar-sync.log                ðŸ“ Daily sync logs
```

---

## âœ… Checklist

- [ ] PostgreSQL installed and running
- [ ] Python dependencies installed (`psycopg2-binary`, `requests`)
- [ ] Database `hotstar_source` created
- [ ] Migrations run successfully (3 tables created)
- [ ] Initial ingestion completed (~51,495 movies)
- [ ] Cron job set up for daily sync
- [ ] Logs directory created
- [ ] First daily sync tested successfully

---

## ðŸš¨ Important Notes

1. **Separate Database:** Hotstar data is in `hotstar_source`, separate from main TLDR database
2. **Rate Limits:** API enforces 1 request/second (automatically handled by scripts)
3. **Token Expiry:** Tokens expire after 33 minutes (auto-regenerated by scripts)
4. **Soft Deletion:** Deleted movies are marked with `is_deleted=true`, not removed
5. **Raw Data:** Complete API response stored in `raw_response` column for debugging

---

**Setup Time:** ~5 minutes (excluding initial ingestion)
**Initial Ingestion Time:** ~1-2 minutes
**Daily Sync Time:** ~5-10 seconds

**Status:** âœ… Ready to deploy!
